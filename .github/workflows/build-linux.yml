name: build-linux

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'  # Trigger on version tags

jobs:
  build-linux-appimage:
    runs-on: ubuntu-latest

    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Cache Flutter
        uses: actions/cache@v4
        id: flutter-cache
        with:
          key: flutter-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            flutter-${{ runner.os }}-
          path: ~/.flutter

      - name: Install Linux dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            liblzma-dev \
            build-essential \
            libwebkitgtk-6.0-dev \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            libgstreamer-plugins-good1.0-dev \
            gstreamer1.0-plugins-good \
            gstreamer1.0-plugins-bad \
            gstreamer1.0-libav

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Enable Linux platform
        run: flutter config --enable-linux-desktop

      - name: Get dependencies
        run: flutter pub get

      - name: Build Linux release
        run: |
          flutter build linux --release

      - name: Download AppImageTool
        run: |
          wget -O appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool

      - name: Create AppImage
        run: |
          # Create AppDir structure
          mkdir -p AppDir

          # Copy built Flutter app
          cp -r build/linux/x64/release/bundle/* AppDir/

          # Create desktop entry
          mkdir -p AppDir/usr/share/applications
          cat > AppDir/flutter_catalog.desktop << 'EOF'
          [Desktop Entry]
          Type=Application
          Name=Flutter Catalog
          Comment=A Flutter showcase application
          Exec=flutter_catalog
          Icon=flutter_catalog
          Categories=Development;
          EOF

          # Create AppRun script
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "${0}")")"
          export LD_LIBRARY_PATH="${HERE}/lib:${LD_LIBRARY_PATH}"
          exec "${HERE}/flutter_catalog" "$@"
          EOF
          chmod +x AppDir/AppRun

          # Create a simple icon (256x256 blue square with text)
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          # Use ImageMagick to create icon if available, otherwise use a fallback
          if command -v convert &> /dev/null; then
            sudo apt-get install -y imagemagick
            convert -size 256x256 xc:blue -pointsize 24 -fill white -gravity center -annotate +0+0 "Flutter\nCatalog" AppDir/flutter_catalog.png
          else
            # Create placeholder icon file
            echo "Icon placeholder" > AppDir/flutter_catalog.png
          fi
          cp AppDir/flutter_catalog.png AppDir/usr/share/icons/hicolor/256x256/apps/

          # Build AppImage
          ARCH=x86_64 ./appimagetool AppDir flutter_catalog-linux-x86_64.AppImage

      - name: Test AppImage
        run: |
          file flutter_catalog-linux-x86_64.AppImage
          ls -la flutter_catalog-linux-x86_64.AppImage

      - name: Upload AppImage as artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: flutter_catalog-linux-x86_64.AppImage
          retention-days: 30

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          body: |
            ## üêß Linux AppImage

            This release contains a Linux AppImage file:
            - **Universal AppImage**: Compatible with most Linux distributions (x86_64)

            ### Installation
            1. Download the AppImage file
            2. Make it executable: `chmod +x flutter_catalog-linux-x86_64.AppImage`
            3. Run it: `./flutter_catalog-linux-x86_64.AppImage`

            ### System Requirements
            - Linux x86_64 (64-bit)
            - GTK+ 3.0 or higher

            ### What's Changed
            - Auto-generated from tag ${{ github.ref_name }}
          draft: false
          prerelease: false

      - name: Upload AppImage to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: flutter_catalog-linux-x86_64.AppImage
          asset_name: flutter-catalog-${{ github.ref_name }}-linux-x86_64.AppImage
          asset_content_type: application/octet-stream